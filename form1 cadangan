using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Numerics;
using System.Windows.Forms;
using OxyPlot;
using OxyPlot.Series;
using OxyPlot.WindowsForms;
using OxyPlot.Axes;
using OxyPlot.Annotations;
using MathNet.Numerics;
using MathNet.Numerics.IntegralTransforms;
using OpenTK;
using OpenTK.Graphics;
using OpenTK.Graphics.OpenGL;

namespace CoolingTowerSimulation
{
    public partial class Form1 : Form
    {
        // Controls
        private TabControl tabControl;
        private TabPage tabParameters, tabTimeDomain, tabFrequencyDomain, tabLaplace, tabZDomain, tab3DModel;

        // Parameter Controls
        private NumericUpDown numAmbientTemp, numHumidity, numWindSpeed, numMechanicalVib, numWaterTemp;
        private Button btnSimulate, btnStopSimulation, btnUpdateAnalysis;
        private Label lblStatus;

        // Plot Views
        private readonly PlotView[] timePlots = new PlotView[5];
        private readonly PlotView[] freqPlots = new PlotView[5];
        private PlotView plotLaplace, plotZDomain;
        private RichTextBox rtbLaplace, rtbZDomain;

        // 3D Model Controls
        private OpenTK.GLControl glControl;
        private Timer renderTimer;
        private float rotationX = 30f;
        private float rotationY = 45f;
        private float zoom = -15f;
        private bool isDragging = false;
        private Point lastMousePos;
        private CheckBox chkShowTemp, chkShowHumidity, chkShowAirflow, chkShowVibration, chkShowDO;
        private CheckBox chkRotate;
        private Label lbl3DInfo;

        // Data Storage
        private SensorData sensorData;

        // Multi-Rate Sampling
        private readonly int[] samplingRates = new int[5] { 2, 1, 5, 1000, 1 };
        private readonly double duration = 10.0;

        // Realtime simulation
        private Timer simulationTimer;
        private double currentTime = 0;
        private readonly double timeWindow = 10.0;
        private bool isSimulating = false;
        private Random rand = new Random(42);

        // Parameters
        private double ambientTemp, humidity, windSpeed, mechVib, waterTemp;

        // Sensor time constants
        private readonly double tempTau = 0.5;
        private readonly double humidityTau = 0.67;
        private readonly double airflowTau = 0.2;
        private readonly double vibrationTau = 0.02;
        private readonly double doTau = 1.25;

        public Form1()
        {
            InitializeComponent();
            InitializeUI();
            InitializeTimer();
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();
            this.ClientSize = new Size(1400, 900);
            this.Text = "Cooling Tower Efficiency Analysis - Multi-Rate Sampling with 3D Model";
            this.StartPosition = FormStartPosition.CenterScreen;
            this.ResumeLayout(false);
        }

        private void InitializeTimer()
        {
            simulationTimer = new Timer { Interval = 50 };
            simulationTimer.Tick += SimulationTimer_Tick;

            renderTimer = new Timer { Interval = 16 }; // ~60 FPS
            renderTimer.Tick += RenderTimer_Tick;
        }

        private void InitializeUI()
        {
            tabControl = new TabControl { Dock = DockStyle.Fill, Font = new Font("Segoe UI", 9F) };

            tabParameters = new TabPage("Parameter Input");
            tabTimeDomain = new TabPage("Time Domain (REALTIME)");
            tabFrequencyDomain = new TabPage("Frequency Domain (FFT)");
            tabLaplace = new TabPage("S-Domain (Laplace)");
            tabZDomain = new TabPage("Z-Domain (Discrete)");
            tab3DModel = new TabPage("3D Sensor Layout");

            tabControl.TabPages.AddRange(new[] { tabParameters, tabTimeDomain, tabFrequencyDomain, tabLaplace, tabZDomain, tab3DModel });

            InitializeParameterTab();
            InitializeTimeDomainTab();
            InitializeFrequencyTab();
            InitializeLaplaceTab();
            InitializeZDomainTab();
            Initialize3DTab();

            this.Controls.Add(tabControl);
        }

        private void InitializeParameterTab()
        {
            Panel panel = new Panel { Dock = DockStyle.Fill, AutoScroll = true, Padding = new Padding(20) };
            int yPos = 20;

            Label title = new Label
            {
                Text = "Sensor Input Parameters Configuration",
                Font = new Font("Segoe UI", 14F, FontStyle.Bold),
                Location = new Point(20, yPos),
                AutoSize = true
            };
            panel.Controls.Add(title);
            yPos += 50;

            AddParameterControl(panel, "Ambient Temperature (¬∞C):", 25m, 0m, 50m, ref numAmbientTemp, ref yPos);
            AddParameterControl(panel, "Relative Humidity (%):", 60m, 0m, 100m, ref numHumidity, ref yPos);
            AddParameterControl(panel, "Wind Speed (m/s):", 5m, 0m, 30m, ref numWindSpeed, ref yPos);
            AddParameterControl(panel, "Mechanical Vibration Base (g):", 0.5m, 0m, 5m, ref numMechanicalVib, ref yPos);
            AddParameterControl(panel, "Water Temperature (¬∞C):", 30m, 10m, 60m, ref numWaterTemp, ref yPos);

            yPos += 20;

            btnSimulate = new Button
            {
                Text = "‚ñ∂ Start Realtime Simulation",
                Location = new Point(20, yPos),
                Size = new Size(200, 40),
                Font = new Font("Segoe UI", 10F, FontStyle.Bold),
                BackColor = Color.FromArgb(0, 150, 0),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            btnSimulate.Click += BtnSimulate_Click;
            panel.Controls.Add(btnSimulate);

            btnStopSimulation = new Button
            {
                Text = "‚èπ Stop Simulation",
                Location = new Point(240, yPos),
                Size = new Size(180, 40),
                Font = new Font("Segoe UI", 10F, FontStyle.Bold),
                BackColor = Color.FromArgb(200, 0, 0),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Enabled = false
            };
            btnStopSimulation.Click += BtnStopSimulation_Click;
            panel.Controls.Add(btnStopSimulation);

            yPos += 50;

            btnUpdateAnalysis = new Button
            {
                Text = "üîÑ Update FFT/Laplace/Z Analysis",
                Location = new Point(20, yPos),
                Size = new Size(260, 40),
                Font = new Font("Segoe UI", 9F, FontStyle.Bold),
                BackColor = Color.FromArgb(0, 120, 215),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            btnUpdateAnalysis.Click += (s, ev) => GenerateStaticAnalysis();
            panel.Controls.Add(btnUpdateAnalysis);

            yPos += 50;

            lblStatus = new Label
            {
                Text = "Status: Stopped",
                Location = new Point(20, yPos),
                Size = new Size(600, 30),
                Font = new Font("Segoe UI", 10F, FontStyle.Bold),
                ForeColor = Color.Gray
            };
            panel.Controls.Add(lblStatus);
            yPos += 40;

            Label info = new Label
            {
                Text = "Multi-Rate Sampling Strategy:\n" +
                       "‚Ä¢ Temperature (SHT85): 2 Hz - œÑ=0.5s, Bandwidth=0.32 Hz\n" +
                       "‚Ä¢ Humidity (SHT85): 1 Hz - œÑ=0.67s, Bandwidth=0.24 Hz\n" +
                       "‚Ä¢ Airflow (Testo 440): 5 Hz - œÑ=0.2s, Bandwidth=0.80 Hz\n" +
                       "‚Ä¢ Vibration (PCB 352C33): 1000 Hz - œÑ=0.02s, captures 60-120 Hz\n" +
                       "‚Ä¢ Dissolved Oxygen (Apera DO850): 1 Hz - œÑ=1.25s, Bandwidth=0.13 Hz\n\n" +
                       "‚ö†Ô∏è UBAH PARAMETER SAAT SIMULASI untuk melihat efek real-time!",
                Location = new Point(20, yPos),
                Size = new Size(900, 180),
                Font = new Font("Segoe UI", 9F, FontStyle.Italic),
                ForeColor = Color.DarkBlue
            };
            panel.Controls.Add(info);

            tabParameters.Controls.Add(panel);
        }

        private void AddParameterControl(Panel panel, string label, decimal defaultVal, decimal min, decimal max,
                                        ref NumericUpDown control, ref int yPos)
        {
            Label lbl = new Label
            {
                Text = label,
                Location = new Point(20, yPos),
                Size = new Size(250, 25),
                Font = new Font("Segoe UI", 9F)
            };

            control = new NumericUpDown
            {
                Location = new Point(280, yPos),
                Size = new Size(120, 25),
                Minimum = min,
                Maximum = max,
                Value = defaultVal,
                DecimalPlaces = 2,
                Increment = 0.5m
            };

            panel.Controls.Add(lbl);
            panel.Controls.Add(control);
            yPos += 40;
        }

        private void InitializeTimeDomainTab()
        {
            Panel panel = new Panel { Dock = DockStyle.Fill, AutoScroll = true };

            string[] titles = {
                "Temperature (¬∞C) - REALTIME [SHT85, fs=2Hz]",
                "Humidity (%) - REALTIME [SHT85, fs=1Hz]",
                "Airflow (m/s) - REALTIME [Testo 440, fs=5Hz]",
                "Vibration (g) - REALTIME [PCB 352C33, fs=1000Hz]",
                "Dissolved Oxygen (mg/L) - REALTIME [Apera DO850, fs=1Hz]"
            };

            for (int i = 0; i < 5; i++)
            {
                timePlots[i] = new PlotView
                {
                    Location = new Point(10, 10 + i * 170),
                    Size = new Size(1350, 160),
                    BackColor = Color.White
                };

                var model = new PlotModel { Title = titles[i] };
                model.Axes.Add(new LinearAxis
                {
                    Position = AxisPosition.Bottom,
                    Title = "Time (s)",
                    Minimum = 0,
                    Maximum = timeWindow,
                    MajorGridlineStyle = LineStyle.Solid,
                    MinorGridlineStyle = LineStyle.Dot,
                    MajorGridlineColor = OxyColors.LightGray
                });
                model.Axes.Add(new LinearAxis
                {
                    Position = AxisPosition.Left,
                    Title = titles[i].Split('-')[0].Trim(),
                    MajorGridlineStyle = LineStyle.Solid,
                    MinorGridlineStyle = LineStyle.Dot,
                    MajorGridlineColor = OxyColors.LightGray
                });

                var series = new LineSeries
                {
                    Color = OxyColors.Blue,
                    StrokeThickness = 2,
                    LineStyle = LineStyle.Solid
                };
                model.Series.Add(series);

                timePlots[i].Model = model;
                panel.Controls.Add(timePlots[i]);
            }

            tabTimeDomain.Controls.Add(panel);
        }

        private void InitializeFrequencyTab()
        {
            Panel panel = new Panel { Dock = DockStyle.Fill, AutoScroll = true };

            string[] titles = {
                "Temperature Spectrum",
                "Humidity Spectrum",
                "Airflow Spectrum",
                "Vibration Spectrum",
                "Dissolved Oxygen Spectrum"
            };

            for (int i = 0; i < 5; i++)
            {
                freqPlots[i] = new PlotView
                {
                    Location = new Point(10, 10 + i * 170),
                    Size = new Size(1350, 160),
                    BackColor = Color.White
                };

                var model = new PlotModel { Title = titles[i] };
                model.Axes.Add(new LinearAxis
                {
                    Position = AxisPosition.Bottom,
                    Title = "Frequency (Hz)",
                    MajorGridlineStyle = LineStyle.Solid,
                    MinorGridlineStyle = LineStyle.Dot,
                    MajorGridlineColor = OxyColors.LightGray
                });
                model.Axes.Add(new LinearAxis
                {
                    Position = AxisPosition.Left,
                    Title = "Magnitude",
                    MajorGridlineStyle = LineStyle.Solid,
                    MinorGridlineStyle = LineStyle.Dot,
                    MajorGridlineColor = OxyColors.LightGray
                });
                freqPlots[i].Model = model;

                panel.Controls.Add(freqPlots[i]);
            }

            tabFrequencyDomain.Controls.Add(panel);
        }

        private void InitializeLaplaceTab()
        {
            Panel mainPanel = new Panel { Dock = DockStyle.Fill };
            SplitContainer split = new SplitContainer
            {
                Dock = DockStyle.Fill,
                Orientation = Orientation.Vertical,
                SplitterDistance = 600
            };

            rtbLaplace = new RichTextBox
            {
                Dock = DockStyle.Fill,
                Font = new Font("Consolas", 9F),
                ReadOnly = true,
                BackColor = Color.WhiteSmoke,
                Padding = new Padding(10)
            };
            split.Panel1.Controls.Add(rtbLaplace);

            Panel plotPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(10) };
            Label lblPlot = new Label
            {
                Text = "Pole Plot (S-Plane)",
                Dock = DockStyle.Top,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                Height = 30,
                TextAlign = ContentAlignment.MiddleCenter
            };

            plotLaplace = new PlotView { Dock = DockStyle.Fill, BackColor = Color.White };

            plotPanel.Controls.Add(plotLaplace);
            plotPanel.Controls.Add(lblPlot);
            split.Panel2.Controls.Add(plotPanel);

            mainPanel.Controls.Add(split);
            tabLaplace.Controls.Add(mainPanel);
        }

        private void InitializeZDomainTab()
        {
            Panel mainPanel = new Panel { Dock = DockStyle.Fill };
            SplitContainer split = new SplitContainer
            {
                Dock = DockStyle.Fill,
                Orientation = Orientation.Vertical,
                SplitterDistance = 600
            };

            rtbZDomain = new RichTextBox
            {
                Dock = DockStyle.Fill,
                Font = new Font("Consolas", 9F),
                ReadOnly = true,
                BackColor = Color.WhiteSmoke,
                Padding = new Padding(10)
            };
            split.Panel1.Controls.Add(rtbZDomain);

            Panel plotPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(10) };
            Label lblPlot = new Label
            {
                Text = "Pole-Zero Map (Z-Plane with Unit Circle)",
                Dock = DockStyle.Top,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                Height = 30,
                TextAlign = ContentAlignment.MiddleCenter
            };

            plotZDomain = new PlotView { Dock = DockStyle.Fill, BackColor = Color.White };

            plotPanel.Controls.Add(plotZDomain);
            plotPanel.Controls.Add(lblPlot);
            split.Panel2.Controls.Add(plotPanel);

            mainPanel.Controls.Add(split);
            tabZDomain.Controls.Add(mainPanel);
        }

        private void Initialize3DTab()
        {
            Panel mainPanel = new Panel { Dock = DockStyle.Fill };
            SplitContainer split = new SplitContainer
            {
                Dock = DockStyle.Fill,
                Orientation = Orientation.Horizontal,
                SplitterDistance = 700
            };

            // 3D View Panel
            glControl = new OpenTK.GLControl(new GraphicsMode(32, 24, 0, 4));
            glControl.Dock = DockStyle.Fill;
            glControl.Load += GlControl_Load;
            glControl.Paint += GlControl_Paint;
            glControl.Resize += GlControl_Resize;
            glControl.MouseDown += GlControl_MouseDown;
            glControl.MouseMove += GlControl_MouseMove;
            glControl.MouseUp += GlControl_MouseUp;
            glControl.MouseWheel += GlControl_MouseWheel;
            split.Panel1.Controls.Add(glControl);

            // ‚úÖ CONTROL PANEL - Didefinisikan di sini
            Panel controlPanel = new Panel { Dock = DockStyle.Fill, Padding = new Padding(10) };

            Label titleLabel = new Label
            {
                Text = "3D COOLING TOWER - SENSOR PLACEMENT VISUALIZATION",
                Location = new Point(10, 10),
                Size = new Size(800, 25),
                Font = new Font("Segoe UI", 12F, FontStyle.Bold),
                ForeColor = Color.DarkBlue
            };
            controlPanel.Controls.Add(titleLabel);

            // Sensor visibility checkboxes
            int xPos = 10;
            int yPos = 45;

            Label lblSensors = new Label
            {
                Text = "Sensor Visibility:",
                Location = new Point(xPos, yPos),
                Size = new Size(120, 20),
                Font = new Font("Segoe UI", 9F, FontStyle.Bold)
            };
            controlPanel.Controls.Add(lblSensors);
            yPos += 25;

            chkShowTemp = CreateCheckBox("üå°Ô∏è Temperature (Top)", xPos, yPos, true);
            controlPanel.Controls.Add(chkShowTemp);
            xPos += 180;

            chkShowHumidity = CreateCheckBox("üíß Humidity (Mid-Top)", xPos, yPos, true);
            controlPanel.Controls.Add(chkShowHumidity);
            xPos += 180;

            chkShowAirflow = CreateCheckBox("üå¨Ô∏è Airflow (Sides)", xPos, yPos, true);
            controlPanel.Controls.Add(chkShowAirflow);
            xPos += 180;

            chkShowVibration = CreateCheckBox("üì≥ Vibration (Base)", xPos, yPos, true);
            controlPanel.Controls.Add(chkShowVibration);
            xPos += 180;

            chkShowDO = CreateCheckBox("‚öóÔ∏è DO (Water Basin)", xPos, yPos, true);
            controlPanel.Controls.Add(chkShowDO);

            yPos += 35;
            xPos = 10;

            chkRotate = new CheckBox
            {
                Text = "üîÑ Auto-Rotate",
                Location = new Point(xPos, yPos),
                Size = new Size(150, 25),
                Font = new Font("Segoe UI", 9F, FontStyle.Bold),
                Checked = true
            };
            controlPanel.Controls.Add(chkRotate);

            Button btnReset = new Button
            {
                Text = "‚Ü∫ Reset View",
                Location = new Point(xPos + 160, yPos - 2),
                Size = new Size(120, 28),
                Font = new Font("Segoe UI", 9F),
                BackColor = Color.FromArgb(0, 120, 215),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            btnReset.Click += (s, ev) => { rotationX = 30f; rotationY = 45f; zoom = -15f; };
            controlPanel.Controls.Add(btnReset);

            yPos += 40;

            lbl3DInfo = new Label
            {
                Text = "üìç SENSOR LOCATIONS:\n" +
                       "‚Ä¢ Temperature (SHT85): Top of tower - measures outlet air temperature\n" +
                       "‚Ä¢ Humidity (SHT85): Mid-top section - measures air moisture after cooling\n" +
                       "‚Ä¢ Airflow (Testo 440): Side panels (4x) - measures air velocity distribution\n" +
                       "‚Ä¢ Vibration (PCB 352C33): Base foundation - detects mechanical issues\n" +
                       "‚Ä¢ Dissolved Oxygen (Apera DO850): Water basin - measures water quality\n\n" +
                       "üñ±Ô∏è CONTROLS: Left-drag to rotate | Scroll to zoom",
                Location = new Point(xPos, yPos),
                Size = new Size(1350, 120),
                Font = new Font("Segoe UI", 9F),
                ForeColor = Color.DarkSlateGray
            };
            controlPanel.Controls.Add(lbl3DInfo);

            // ‚úÖ Tambahkan controlPanel ke split panel
            split.Panel2.Controls.Add(controlPanel);
            mainPanel.Controls.Add(split);
            tab3DModel.Controls.Add(mainPanel);

            // ‚úÖ Start render timer dengan aman setelah semua kontrol dibuat
            if (renderTimer != null && !renderTimer.Enabled)
            {
                renderTimer.Start();
            }
        }

        private CheckBox CreateCheckBox(string text, int x, int y, bool isChecked)
        {
            return new CheckBox
            {
                Text = text,
                Location = new Point(x, y),
                Size = new Size(170, 25),
                Checked = isChecked,
                Font = new Font("Segoe UI", 9F)
            };
        }

        private void GlControl_Load(object sender, EventArgs e)
        {
            GL.ClearColor(0.95f, 0.95f, 0.98f, 1.0f);
            GL.Enable(EnableCap.DepthTest);
            GL.Enable(EnableCap.Lighting);
            GL.Enable(EnableCap.Light0);
            GL.Enable(EnableCap.ColorMaterial);
            GL.Enable(EnableCap.Blend);
            GL.BlendFunc(BlendingFactor.SrcAlpha, BlendingFactor.OneMinusSrcAlpha);
            GL.Enable(EnableCap.LineSmooth);
            GL.Hint(HintTarget.LineSmoothHint, HintMode.Nicest);

            // Setup lighting
            GL.Light(LightName.Light0, LightParameter.Position, new float[] { 5f, 10f, 5f, 1f });
            GL.Light(LightName.Light0, LightParameter.Ambient, new float[] { 0.3f, 0.3f, 0.3f, 1f });
            GL.Light(LightName.Light0, LightParameter.Diffuse, new float[] { 0.8f, 0.8f, 0.8f, 1f });
            GL.Light(LightName.Light0, LightParameter.Specular, new float[] { 1f, 1f, 1f, 1f });

            SetupViewport();
        }

        private void GlControl_Resize(object sender, EventArgs e)
        {
            SetupViewport();
        }

        private void SetupViewport()
        {
            if (glControl.Width == 0 || glControl.Height == 0) return;

            GL.Viewport(0, 0, glControl.Width, glControl.Height);
            GL.MatrixMode(MatrixMode.Projection);
            GL.LoadIdentity();

            float aspect = (float)glControl.Width / (float)glControl.Height;
            Matrix4 perspective = Matrix4.CreatePerspectiveFieldOfView(
                MathHelper.DegreesToRadians(45f), aspect, 0.1f, 100f);
            GL.LoadMatrix(ref perspective);

            GL.MatrixMode(MatrixMode.Modelview);
        }

        private void RenderTimer_Tick(object sender, EventArgs e)
        {
            if (chkRotate?.Checked == true)
            {
                rotationY += 0.5f;
            }
            glControl?.Invalidate();
        }

        private void GlControl_Paint(object sender, System.Windows.Forms.PaintEventArgs e)
        {
            GL.Clear(ClearBufferMask.ColorBufferBit | ClearBufferMask.DepthBufferBit);
            GL.LoadIdentity();

            // Camera setup
            GL.Translate(0f, 0f, zoom);
            GL.Rotate(rotationX, 1f, 0f, 0f);
            GL.Rotate(rotationY, 0f, 1f, 0f);

            // Draw coordinate axes
            DrawAxes();

            // Draw cooling tower
            DrawCoolingTower();

            // Draw sensors
            if (chkShowTemp?.Checked == true) DrawTemperatureSensor();
            if (chkShowHumidity?.Checked == true) DrawHumiditySensor();
            if (chkShowAirflow?.Checked == true) DrawAirflowSensors();
            if (chkShowVibration?.Checked == true) DrawVibrationSensor();
            if (chkShowDO?.Checked == true) DrawDOSensor();

            glControl.SwapBuffers();
        }

        private void DrawAxes()
        {
            GL.Disable(EnableCap.Lighting);
            GL.LineWidth(2f);

            GL.Begin(PrimitiveType.Lines);

            // X-axis (Red)
            GL.Color3(1f, 0f, 0f);
            GL.Vertex3(0f, 0f, 0f);
            GL.Vertex3(3f, 0f, 0f);

            // Y-axis (Green)
            GL.Color3(0f, 1f, 0f);
            GL.Vertex3(0f, 0f, 0f);
            GL.Vertex3(0f, 3f, 0f);

            // Z-axis (Blue)
            GL.Color3(0f, 0f, 1f);
            GL.Vertex3(0f, 0f, 0f);
            GL.Vertex3(0f, 0f, 3f);

            GL.End();
            GL.Enable(EnableCap.Lighting);
        }

        private void DrawCoolingTower()
        {
            // Tower structure - hyperboloid shape
            GL.Color4(0.7f, 0.85f, 0.95f, 0.8f);

            int segments = 32;
            float height = 8f;
            float baseRadius = 2.5f;
            float topRadius = 2.0f;
            float minRadius = 1.8f;
            float waistHeight = height * 0.4f;

            // Draw tower surface
            GL.Begin(PrimitiveType.QuadStrip);
            for (int i = 0; i <= segments; i++)
            {
                float angle = (float)i / segments * MathHelper.TwoPi;
                float cosA = (float)Math.Cos(angle);
                float sinA = (float)Math.Sin(angle);

                for (float h = 0; h <= height; h += 0.3f)
                {
                    float t = h / height;
                    float radius;

                    // Hyperboloid shape
                    if (h < waistHeight)
                    {
                        float localT = h / waistHeight;
                        radius = baseRadius - (baseRadius - minRadius) * localT;
                    }
                    else
                    {
                        float localT = (h - waistHeight) / (height - waistHeight);
                        radius = minRadius + (topRadius - minRadius) * localT;
                    }

                    float x = radius * cosA;
                    float z = radius * sinA;

                    GL.Normal3(cosA, 0f, sinA);
                    GL.Vertex3(x, h, z);
                }
            }
            GL.End();

            // Draw base platform
            GL.Color4(0.5f, 0.5f, 0.5f, 0.9f);
            DrawCylinder(0f, -0.3f, 0f, 3.5f, 0.3f, 32);

            // Draw water basin
            GL.Color4(0.3f, 0.5f, 0.8f, 0.7f);
            DrawCylinder(0f, -0.5f, 0f, 3.0f, 0.2f, 32);

            // Draw top rim
            GL.Color4(0.6f, 0.6f, 0.6f, 0.9f);
            DrawCylinder(0f, height, 0f, topRadius + 0.2f, 0.2f, 32);
        }

        private void DrawTemperatureSensor()
        {
            float y = 8.5f;

            // Sensor box
            GL.Color4(1f, 0.3f, 0.3f, 0.9f);
            DrawCube(0f, y, 0f, 0.3f);

            // Label indicator
            GL.Disable(EnableCap.Lighting);
            GL.Color3(1f, 0f, 0f);
            GL.LineWidth(3f);
            GL.Begin(PrimitiveType.Lines);
            GL.Vertex3(0f, y, 0f);
            GL.Vertex3(0f, y + 1.5f, 0f);
            GL.End();

            // Antenna
            DrawCylinder(0f, y, 0f, 0.05f, 0.6f, 8);
            GL.Enable(EnableCap.Lighting);
        }

        private void DrawHumiditySensor()
        {
            float y = 6.5f;
            float radius = 2.0f;

            // Sensor box
            GL.Color4(0.3f, 0.6f, 1f, 0.9f);
            DrawCube(radius, y, 0f, 0.25f);

            // Connection wire
            GL.Disable(EnableCap.Lighting);
            GL.Color3(0.2f, 0.4f, 0.8f);
            GL.LineWidth(2f);
            GL.Begin(PrimitiveType.Lines);
            GL.Vertex3(radius, y, 0f);
            GL.Vertex3(radius + 1f, y + 0.5f, 0f);
            GL.End();
            GL.Enable(EnableCap.Lighting);
        }

        private void DrawAirflowSensors()
        {
            float y = 4f;
            float radius = 2.2f;

            float[] angles = { 0f, 90f, 180f, 270f };

            foreach (float angle in angles)
            {
                float rad = MathHelper.DegreesToRadians(angle);
                float x = radius * (float)Math.Cos(rad);
                float z = radius * (float)Math.Sin(rad);

                // Sensor probe
                GL.Color4(0.2f, 0.8f, 0.4f, 0.9f);
                DrawCylinder(x, y, z, 0.1f, 0.5f, 8);

                // Mounting bracket
                GL.Color4(0.5f, 0.5f, 0.5f, 0.9f);
                DrawCube(x * 0.8f, y, z * 0.8f, 0.15f);
            }
        }

        private void DrawVibrationSensor()
        {
            float y = -0.2f;

            // Sensor body
            GL.Color4(1f, 0.5f, 0f, 0.9f);
            DrawCube(2.8f, y, 0f, 0.2f);

            // Mounting bolts
            GL.Color4(0.3f, 0.3f, 0.3f, 1f);
            DrawCylinder(2.6f, y - 0.1f, 0f, 0.05f, 0.1f, 8);
            DrawCylinder(3.0f, y - 0.1f, 0f, 0.05f, 0.1f, 8);

            // Cable
            GL.Disable(EnableCap.Lighting);
            GL.Color3(0.8f, 0.4f, 0f);
            GL.LineWidth(2f);
            GL.Begin(PrimitiveType.LineStrip);
            for (int i = 0; i <= 20; i++)
            {
                float t = i / 20f;
                float x = 2.8f + t * 1.5f;
                float yy = y + (float)Math.Sin(t * 6f) * 0.1f;
                GL.Vertex3(x, yy, 0f);
            }
            GL.End();
            GL.Enable(EnableCap.Lighting);
        }

        private void DrawDOSensor()
        {
            float y = -0.4f;

            // Probe in water
            GL.Color4(0.6f, 0.3f, 0.8f, 0.9f);
            DrawCylinder(0f, y, 2.0f, 0.08f, 0.8f, 12);

            // Sensor head
            GL.Color4(0.5f, 0.2f, 0.7f, 0.9f);
            DrawSphere(0f, y - 0.8f, 2.0f, 0.15f, 12);

            // Mounting arm
            GL.Color4(0.4f, 0.4f, 0.4f, 0.9f);
            GL.Begin(PrimitiveType.Quads);
            GL.Normal3(0f, 1f, 0f);
            GL.Vertex3(-0.1f, y, 1.5f);
            GL.Vertex3(0.1f, y, 1.5f);
            GL.Vertex3(0.1f, y, 2.5f);
            GL.Vertex3(-0.1f, y, 2.5f);
            GL.End();
        }

        private void DrawCube(float x, float y, float z, float size)
        {
            float s = size / 2f;

            GL.Begin(PrimitiveType.Quads);

            // Front
            GL.Normal3(0f, 0f, 1f);
            GL.Vertex3(x - s, y - s, z + s);
            GL.Vertex3(x + s, y - s, z + s);
            GL.Vertex3(x + s, y + s, z + s);
            GL.Vertex3(x - s, y + s, z + s);

            // Back
            GL.Normal3(0f, 0f, -1f);
            GL.Vertex3(x - s, y - s, z - s);
            GL.Vertex3(x - s, y + s, z - s);
            GL.Vertex3(x + s, y + s, z - s);
            GL.Vertex3(x + s, y - s, z - s);

            // Top
            GL.Normal3(0f, 1f, 0f);
            GL.Vertex3(x - s, y + s, z - s);
            GL.Vertex3(x - s, y + s, z + s);
            GL.Vertex3(x + s, y + s, z + s);
            GL.Vertex3(x + s, y + s, z - s);

            // Bottom
            GL.Normal3(0f, -1f, 0f);
            GL.Vertex3(x - s, y - s, z - s);
            GL.Vertex3(x + s, y - s, z - s);
            GL.Vertex3(x + s, y - s, z + s);
            GL.Vertex3(x - s, y - s, z + s);

            // Right
            GL.Normal3(1f, 0f, 0f);
            GL.Vertex3(x + s, y - s, z - s);
            GL.Vertex3(x + s, y + s, z - s);
            GL.Vertex3(x + s, y + s, z + s);
            GL.Vertex3(x + s, y - s, z + s);

            // Left
            GL.Normal3(-1f, 0f, 0f);
            GL.Vertex3(x - s, y - s, z - s);
            GL.Vertex3(x - s, y - s, z + s);
            GL.Vertex3(x - s, y + s, z + s);
            GL.Vertex3(x - s, y + s, z - s);

            GL.End();
        }

        private void DrawCylinder(float x, float y, float z, float radius, float height, int segments)
        {
            GL.Begin(PrimitiveType.QuadStrip);
            for (int i = 0; i <= segments; i++)
            {
                float angle = (float)i / segments * MathHelper.TwoPi;
                float cosA = (float)Math.Cos(angle);
                float sinA = (float)Math.Sin(angle);

                GL.Normal3(cosA, 0f, sinA);
                GL.Vertex3(x + radius * cosA, y, z + radius * sinA);
                GL.Vertex3(x + radius * cosA, y + height, z + radius * sinA);
            }
            GL.End();

            // Top cap
            GL.Begin(PrimitiveType.TriangleFan);
            GL.Normal3(0f, 1f, 0f);
            GL.Vertex3(x, y + height, z);
            for (int i = 0; i <= segments; i++)
            {
                float angle = (float)i / segments * MathHelper.TwoPi;
                GL.Vertex3(x + radius * (float)Math.Cos(angle), y + height, z + radius * (float)Math.Sin(angle));
            }
            GL.End();

            // Bottom cap
            GL.Begin(PrimitiveType.TriangleFan);
            GL.Normal3(0f, -1f, 0f);
            GL.Vertex3(x, y, z);
            for (int i = segments; i >= 0; i--)
            {
                float angle = (float)i / segments * MathHelper.TwoPi;
                GL.Vertex3(x + radius * (float)Math.Cos(angle), y, z + radius * (float)Math.Sin(angle));
            }
            GL.End();
        }

        private void DrawSphere(float x, float y, float z, float radius, int segments)
        {
            for (int i = 0; i < segments; i++)
            {
                float lat0 = MathHelper.Pi * (-0.5f + (float)i / segments);
                float lat1 = MathHelper.Pi * (-0.5f + (float)(i + 1) / segments);
                float z0 = (float)Math.Sin(lat0);
                float zr0 = (float)Math.Cos(lat0);
                float z1 = (float)Math.Sin(lat1);
                float zr1 = (float)Math.Cos(lat1);

                GL.Begin(PrimitiveType.QuadStrip);
                for (int j = 0; j <= segments; j++)
                {
                    float lng = MathHelper.TwoPi * (float)j / segments;
                    float xx = (float)Math.Cos(lng);
                    float yy = (float)Math.Sin(lng);

                    GL.Normal3(xx * zr0, yy * zr0, z0);
                    GL.Vertex3(x + radius * xx * zr0, y + radius * z0, z + radius * yy * zr0);

                    GL.Normal3(xx * zr1, yy * zr1, z1);
                    GL.Vertex3(x + radius * xx * zr1, y + radius * z1, z + radius * yy * zr1);
                }
                GL.End();
            }
        }

        private void GlControl_MouseDown(object sender, MouseEventArgs e)
        {
            isDragging = true;
            lastMousePos = e.Location;
        }

        private void GlControl_MouseMove(object sender, MouseEventArgs e)
        {
            if (!isDragging) return;

            int deltaX = e.X - lastMousePos.X;
            int deltaY = e.Y - lastMousePos.Y;

            if (e.Button == MouseButtons.Left)
            {
                rotationY += deltaX * 0.5f;
                rotationX += deltaY * 0.5f;

                // Clamp X rotation
                if (rotationX > 90f) rotationX = 90f;
                if (rotationX < -90f) rotationX = -90f;
            }

            lastMousePos = e.Location;
        }

        private void GlControl_MouseUp(object sender, MouseEventArgs e)
        {
            isDragging = false;
        }

        private void GlControl_MouseWheel(object sender, MouseEventArgs e)
        {
            zoom += e.Delta * 0.01f;
            if (zoom > -3f) zoom = -3f;
            if (zoom < -30f) zoom = -30f;
        }

        private void BtnSimulate_Click(object sender, EventArgs e)
        {
            currentTime = 0;

            foreach (var plot in timePlots)
            {
                if (plot?.Model?.Series != null && plot.Model.Series.Count > 0)
                {
                    ((LineSeries)plot.Model.Series[0]).Points.Clear();
                }
            }

            isSimulating = true;
            simulationTimer.Start();

            btnSimulate.Enabled = false;
            btnStopSimulation.Enabled = true;
            lblStatus.Text = "Status: Running - Parameter dapat diubah real-time!";
            lblStatus.ForeColor = Color.Green;

            GenerateStaticAnalysis();
        }

        private void BtnStopSimulation_Click(object sender, EventArgs e)
        {
            simulationTimer.Stop();
            isSimulating = false;

            btnSimulate.Enabled = true;
            btnStopSimulation.Enabled = false;
            lblStatus.Text = "Status: Stopped";
            lblStatus.ForeColor = Color.Gray;
        }

        private void SimulationTimer_Tick(object sender, EventArgs e)
        {
            if (!isSimulating) return;

            ambientTemp = (double)numAmbientTemp.Value;
            humidity = (double)numHumidity.Value;
            windSpeed = (double)numWindSpeed.Value;
            mechVib = (double)numMechanicalVib.Value;
            waterTemp = (double)numWaterTemp.Value;

            currentTime += 0.05;

            UpdateRealtimePlot(timePlots[0], currentTime, CalculateTemperature(currentTime));
            UpdateRealtimePlot(timePlots[1], currentTime, CalculateHumidity(currentTime));
            UpdateRealtimePlot(timePlots[2], currentTime, CalculateAirflow(currentTime));
            UpdateRealtimePlot(timePlots[3], currentTime, CalculateVibration(currentTime));
            UpdateRealtimePlot(timePlots[4], currentTime, CalculateDissolvedOxygen(currentTime));
        }

        private void UpdateRealtimePlot(PlotView plot, double time, double value)
        {
            var series = (LineSeries)plot.Model.Series[0];
            series.Points.Add(new DataPoint(time, value));

            while (series.Points.Count > 0 && series.Points[0].X < time - timeWindow)
            {
                series.Points.RemoveAt(0);
            }

            var xAxis = plot.Model.Axes[0];
            if (time > timeWindow)
            {
                xAxis.Minimum = time - timeWindow;
                xAxis.Maximum = time;
            }

            plot.Model.InvalidatePlot(true);
        }

        private double CalculateTemperature(double t)
        {
            double baseTemp = ambientTemp;
            double periodic = 2 * Math.Sin(2 * Math.PI * 0.5 * t);
            double noise = 0.5 * (rand.NextDouble() - 0.5);
            double windEffect = -0.8 * (windSpeed - 5);
            double vibEffect = 0.3 * mechVib;
            return baseTemp + periodic + windEffect + vibEffect + noise;
        }

        private double CalculateHumidity(double t)
        {
            double baseHumidity = humidity;
            double tempEffect = -1.5 * (ambientTemp - 25);
            double waterEffect = 0.8 * (waterTemp - 30);
            double periodic = 5 * Math.Sin(2 * Math.PI * 0.3 * t);
            double noise = 1 * (rand.NextDouble() - 0.5);
            double windEffect = -0.5 * (windSpeed - 5);
            double result = baseHumidity + tempEffect + waterEffect + periodic + windEffect + noise;
            return Math.Max(0, Math.Min(100, result));
        }

        private double CalculateAirflow(double t)
        {
            double baseAirflow = windSpeed;
            double periodic1 = 1.5 * Math.Sin(2 * Math.PI * 1.0 * t);
            double periodic2 = 0.5 * Math.Sin(2 * Math.PI * 3.0 * t);
            double noise = 0.3 * (rand.NextDouble() - 0.5);
            double tempEffect = 0.3 * (ambientTemp - 25);
            double humidityEffect = -0.05 * (humidity - 60);
            return Math.Max(0, baseAirflow + periodic1 + periodic2 + tempEffect + humidityEffect + noise);
        }

        private double CalculateVibration(double t)
        {
            double fundamental = mechVib * Math.Sin(2 * Math.PI * 60 * t);
            double harmonic = 0.2 * Math.Sin(2 * Math.PI * 120 * t);
            double noise = 0.1 * (rand.NextDouble() - 0.5);
            double windEffect = 0.05 * windSpeed * Math.Sin(2 * Math.PI * 5 * t);
            return fundamental + harmonic + windEffect + noise;
        }

        private double CalculateDissolvedOxygen(double t)
        {
            double tempFactor = (waterTemp - 20) / 10.0;
            double baseDO = 8.0 - 2.0 * tempFactor;
            double periodic = 0.5 * Math.Sin(2 * Math.PI * 0.2 * t);
            double noise = 0.2 * (rand.NextDouble() - 0.5);
            double aerationEffect = 0.5 * (windSpeed - 5);
            double ambientEffect = -0.15 * (ambientTemp - 25);
            return Math.Max(0, baseDO + periodic + aerationEffect + ambientEffect + noise);
        }

        private void GenerateStaticAnalysis()
        {
            ambientTemp = (double)numAmbientTemp.Value;
            humidity = (double)numHumidity.Value;
            windSpeed = (double)numWindSpeed.Value;
            mechVib = (double)numMechanicalVib.Value;
            waterTemp = (double)numWaterTemp.Value;

            sensorData = new SensorData();

            for (int sensorIdx = 0; sensorIdx < 5; sensorIdx++)
            {
                int fs = samplingRates[sensorIdx];
                int numPoints = (int)(fs * duration);
                double dt = 1.0 / fs;

                double[] timeData = new double[numPoints];
                double[] valueData = new double[numPoints];

                for (int i = 0; i < numPoints; i++)
                {
                    double t = i * dt;
                    timeData[i] = t;

                    switch (sensorIdx)
                    {
                        case 0: valueData[i] = CalculateTemperature(t); break;
                        case 1: valueData[i] = CalculateHumidity(t); break;
                        case 2: valueData[i] = CalculateAirflow(t); break;
                        case 3: valueData[i] = CalculateVibration(t); break;
                        case 4: valueData[i] = CalculateDissolvedOxygen(t); break;
                    }
                }

                sensorData.Time[sensorIdx] = timeData;
                sensorData.SensorValues[sensorIdx] = valueData;
            }

            UpdateFrequencyDomainPlots();
            UpdateLaplaceDomain();
            UpdateZDomain();
        }

        private void UpdateFrequencyDomainPlots()
        {
            string[] names = { "Temperature", "Humidity", "Airflow", "Vibration", "DO" };

            for (int i = 0; i < 5; i++)
            {
                UpdateFFTPlot(freqPlots[i], sensorData.SensorValues[i], samplingRates[i], names[i]);
            }
        }

        private void UpdateFFTPlot(PlotView plot, double[] signal, int fs, string title)
        {
            var complex = signal.Select(x => new Complex(x, 0)).ToArray();
            Fourier.Forward(complex, FourierOptions.Matlab);

            int n = complex.Length;
            double[] frequencies = new double[n / 2];
            double[] magnitudes = new double[n / 2];

            for (int i = 0; i < n / 2; i++)
            {
                frequencies[i] = i * fs / (double)n;
                magnitudes[i] = complex[i].Magnitude / n * 2;
            }

            plot.Model.Series.Clear();
            var series = new LineSeries
            {
                Title = $"{title} FFT",
                Color = OxyColors.Red,
                StrokeThickness = 2
            };

            double nyquist = fs / 2.0;
            for (int i = 0; i < frequencies.Length && frequencies[i] <= nyquist; i++)
            {
                series.Points.Add(new DataPoint(frequencies[i], magnitudes[i]));
            }

            plot.Model.Series.Add(series);
            plot.Model.Title = $"{title} Spectrum (fs={fs} Hz, Nyquist={nyquist} Hz)";
            plot.Model.Axes[0].Maximum = nyquist;
            plot.Model.InvalidatePlot(true);
        }

        private void UpdateLaplaceDomain()
        {
            rtbLaplace.Clear();

            rtbLaplace.AppendText("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
            rtbLaplace.AppendText("  COOLING TOWER TRANSFER FUNCTION - LAPLACE DOMAIN (s)\n");
            rtbLaplace.AppendText("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

            rtbLaplace.AppendText("System Transfer Function (Poles Only):\n\n");
            rtbLaplace.AppendText("              K\n");
            rtbLaplace.AppendText("G(s) = ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
            rtbLaplace.AppendText("       (s + p‚ÇÅ)(s + p‚ÇÇ)(s + p‚ÇÉ)(s + p‚ÇÑ)(s + p‚ÇÖ)\n\n");

            rtbLaplace.AppendText("Where: K = 1.5 (System gain)\n\n");

            double[] poles = {
                -1.0 / tempTau,
                -1.0 / humidityTau,
                -1.0 / airflowTau,
                -1.0 / vibrationTau,
                -1.0 / doTau
            };

            rtbLaplace.AppendText("POLES (dari sensor time constants):\n");
            rtbLaplace.AppendText($"  p‚ÇÅ = {poles[0]:F2} (Temp, œÑ={tempTau}s, fs={samplingRates[0]}Hz)\n");
            rtbLaplace.AppendText($"  p‚ÇÇ = {poles[1]:F2} (Hum, œÑ={humidityTau}s, fs={samplingRates[1]}Hz)\n");
            rtbLaplace.AppendText($"  p‚ÇÉ = {poles[2]:F2} (Air, œÑ={airflowTau}s, fs={samplingRates[2]}Hz)\n");
            rtbLaplace.AppendText($"  p‚ÇÑ = {poles[3]:F1} (Vib, œÑ={vibrationTau}s, fs={samplingRates[3]}Hz)\n");
            rtbLaplace.AppendText($"  p‚ÇÖ = {poles[4]:F2} (DO, œÑ={doTau}s, fs={samplingRates[4]}Hz)\n\n");

            rtbLaplace.AppendText("STABILITY ANALYSIS (S-PLANE):\n");
            rtbLaplace.AppendText("  Kriteria: Pole stabil jika Re(s) < 0 (Left Half Plane)\n\n");

            bool stable = true;
            foreach (var pole in poles)
            {
                if (pole >= 0) stable = false;
            }

            rtbLaplace.AppendText("  Verifikasi:\n");
            rtbLaplace.AppendText($"    ‚Ä¢ p‚ÇÅ = {poles[0]:F2} < 0 ‚úì (di LHP)\n");
            rtbLaplace.AppendText($"    ‚Ä¢ p‚ÇÇ = {poles[1]:F2} < 0 ‚úì (di LHP)\n");
            rtbLaplace.AppendText($"    ‚Ä¢ p‚ÇÉ = {poles[2]:F2} < 0 ‚úì (di LHP)\n");
            rtbLaplace.AppendText($"    ‚Ä¢ p‚ÇÑ = {poles[3]:F1} < 0 ‚úì (di LHP)\n");
            rtbLaplace.AppendText($"    ‚Ä¢ p‚ÇÖ = {poles[4]:F2} < 0 ‚úì (di LHP)\n\n");

            if (stable)
                rtbLaplace.AppendText("  ‚Üí SISTEM STABLE ‚úì (Semua poles di LHP)\n\n");
            else
                rtbLaplace.AppendText("  ‚Üí SISTEM UNSTABLE ‚úó\n\n");

            rtbLaplace.AppendText("KARAKTERISTIK SISTEM:\n");
            rtbLaplace.AppendText($"  ‚Ä¢ Dominant pole: p‚ÇÖ={poles[4]:F2} (paling lambat)\n");
            rtbLaplace.AppendText($"  ‚Ä¢ Fastest pole: p‚ÇÑ={poles[3]:F1} (paling cepat)\n");
            rtbLaplace.AppendText("  ‚Ä¢ System order: 5th order\n\n");

            rtbLaplace.AppendText("MULTI-RATE SAMPLING:\n");
            rtbLaplace.AppendText("  ‚Ä¢ Setiap sensor sampling sesuai bandwidth-nya\n");
            rtbLaplace.AppendText("  ‚Ä¢ Bandwidth = 1/(2œÄœÑ)\n");
            rtbLaplace.AppendText("  ‚Ä¢ Nyquist criterion terpenuhi semua\n");

            CreatePoleOnlyPlot(plotLaplace, poles);
        }

        private void UpdateZDomain()
        {
            rtbZDomain.Clear();

            rtbZDomain.AppendText("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
            rtbZDomain.AppendText("  COOLING TOWER DISCRETE TRANSFER FUNCTION - Z DOMAIN\n");
            rtbZDomain.AppendText("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

            string[] sensorNames = { "Temperature", "Humidity", "Airflow", "Vibration", "DO" };
            double[] timeConstants = { tempTau, humidityTau, airflowTau, vibrationTau, doTau };

            rtbZDomain.AppendText("MULTI-RATE SAMPLING VERIFICATION:\n\n");

            for (int i = 0; i < 5; i++)
            {
                double bandwidth = 1.0 / (2 * Math.PI * timeConstants[i]);
                double nyquistMin = 2 * bandwidth;
                int fs = samplingRates[i];

                rtbZDomain.AppendText($"{sensorNames[i]}:\n");
                rtbZDomain.AppendText($"  œÑ = {timeConstants[i]:F2}s\n");
                rtbZDomain.AppendText($"  Bandwidth = {bandwidth:F3} Hz\n");
                rtbZDomain.AppendText($"  Nyquist (min) = {nyquistMin:F3} Hz\n");
                rtbZDomain.AppendText($"  Actual fs = {fs} Hz ");

                if (fs >= nyquistMin)
                    rtbZDomain.AppendText($"‚úì ({fs / nyquistMin:F1}x Nyquist)\n\n");
                else
                    rtbZDomain.AppendText("‚úó ALIASING RISK!\n\n");
            }

            rtbZDomain.AppendText("Z-TRANSFORM (per sensor):\n");
            rtbZDomain.AppendText("z = e^(p¬∑T) where T = 1/fs\n\n");

            double[] poles_s = {
                -1.0 / tempTau,
                -1.0 / humidityTau,
                -1.0 / airflowTau,
                -1.0 / vibrationTau,
                -1.0 / doTau
            };

            double[] poles_z = new double[5];
            bool stable = true;

            rtbZDomain.AppendText("Discrete Poles:\n");
            for (int i = 0; i < 5; i++)
            {
                double T = 1.0 / samplingRates[i];
                poles_z[i] = Math.Exp(poles_s[i] * T);
                double mag = Math.Abs(poles_z[i]);

                rtbZDomain.AppendText($"  z_p{i + 1} = e^({poles_s[i]:F2}√ó{T:F6}) = {poles_z[i]:F6}\n");
                rtbZDomain.AppendText($"       |z| = {mag:F6} ");

                if (mag < 1.0)
                    rtbZDomain.AppendText($"‚úì [{sensorNames[i]}]\n");
                else
                {
                    rtbZDomain.AppendText($"‚úó [{sensorNames[i]}]\n");
                    stable = false;
                }
            }

            rtbZDomain.AppendText("\n");
            if (stable)
                rtbZDomain.AppendText("‚Üí ALL POLES INSIDE UNIT CIRCLE ‚Üí STABLE ‚úì\n\n");
            else
                rtbZDomain.AppendText("‚Üí UNSTABLE SYSTEM ‚úó\n\n");

            rtbZDomain.AppendText("Discrete Zeros (ZOH method):\n");
            double[] zeros_s = { -0.5, -1.2 };
            double T_ref = 1.0 / samplingRates[3];
            double[] zeros_z = zeros_s.Select(z => Math.Exp(z * T_ref)).ToArray();

            for (int i = 0; i < zeros_z.Length; i++)
            {
                rtbZDomain.AppendText($"  z_z{i + 1} = e^({zeros_s[i]:F1}√ó{T_ref:F6}) = {zeros_z[i]:F6}\n");
            }

            rtbZDomain.AppendText("\nADVANTAGES OF MULTI-RATE SAMPLING:\n");
            rtbZDomain.AppendText("‚Ä¢ Energy efficient (slow sensors use less power)\n");
            rtbZDomain.AppendText("‚Ä¢ Optimal data storage (no redundant samples)\n");
            rtbZDomain.AppendText("‚Ä¢ Realistic (matches sensor physics)\n");
            rtbZDomain.AppendText("‚Ä¢ Meets Nyquist for all channels\n");

            CreatePoleZeroPlotWithUnitCircle(plotZDomain, poles_z, zeros_z);
        }

        private void CreatePoleOnlyPlot(PlotView plotView, double[] poles)
        {
            var model = new PlotModel
            {
                Title = "Pole Plot - S-Plane (Stability: LHP)",
                PlotAreaBorderColor = OxyColors.Black
            };

            double minPole = poles.Min();
            double range = Math.Abs(minPole) * 1.3;

            model.Axes.Add(new LinearAxis
            {
                Position = AxisPosition.Bottom,
                Title = "Real (œÉ)",
                MajorGridlineStyle = LineStyle.Solid,
                MinorGridlineStyle = LineStyle.Dot,
                MajorGridlineColor = OxyColors.LightGray,
                AxislineStyle = LineStyle.Solid,
                AxislineThickness = 2,
                Minimum = -range,
                Maximum = range * 0.3
            });

            model.Axes.Add(new LinearAxis
            {
                Position = AxisPosition.Left,
                Title = "Imaginary (jœâ)",
                MajorGridlineStyle = LineStyle.Solid,
                MinorGridlineStyle = LineStyle.Dot,
                MajorGridlineColor = OxyColors.LightGray,
                AxislineStyle = LineStyle.Solid,
                AxislineThickness = 2,
                Minimum = -5,
                Maximum = 5
            });

            model.Annotations.Add(new LineAnnotation
            {
                Type = LineAnnotationType.Vertical,
                X = 0,
                Color = OxyColors.Red,
                StrokeThickness = 3,
                LineStyle = LineStyle.Dash,
                Text = "jœâ-axis (Stability Boundary)"
            });

            var stableRegion = new RectangleAnnotation
            {
                MinimumX = -range,
                MaximumX = 0,
                MinimumY = -5,
                MaximumY = 5,
                Fill = OxyColor.FromArgb(30, 0, 200, 0),
                Text = "STABLE\n(LHP)"
            };
            model.Annotations.Add(stableRegion);

            var unstableRegion = new RectangleAnnotation
            {
                MinimumX = 0,
                MaximumX = range * 0.3,
                MinimumY = -5,
                MaximumY = 5,
                Fill = OxyColor.FromArgb(30, 200, 0, 0),
                Text = "UNSTABLE\n(RHP)"
            };
            model.Annotations.Add(unstableRegion);

            var poleSeries = new ScatterSeries
            {
                MarkerType = MarkerType.Cross,
                MarkerSize = 15,
                MarkerStroke = OxyColors.Blue,
                MarkerStrokeThickness = 4,
                Title = "Poles (X)"
            };

            string[] labels = { "p‚ÇÅ(Temp)", "p‚ÇÇ(Hum)", "p‚ÇÉ(Air)", "p‚ÇÑ(Vib)", "p‚ÇÖ(DO)" };
            for (int i = 0; i < poles.Length; i++)
            {
                poleSeries.Points.Add(new ScatterPoint(poles[i], 0));

                model.Annotations.Add(new TextAnnotation
                {
                    Text = labels[i],
                    TextPosition = new DataPoint(poles[i], 0.3),
                    Font = "Arial",
                    FontSize = 9,
                    TextColor = OxyColors.DarkBlue
                });
            }
            model.Series.Add(poleSeries);

            plotView.Model = model;
            plotView.Model.InvalidatePlot(true);
        }

        private void CreatePoleZeroPlotWithUnitCircle(PlotView plotView, double[] poles, double[] zeros)
        {
            var model = new PlotModel
            {
                Title = "Pole-Zero Map (Z-Plane)",
                PlotAreaBorderColor = OxyColors.Black
            };

            var xAxis = new LinearAxis
            {
                Position = AxisPosition.Bottom,
                Title = "Real",
                MajorGridlineStyle = LineStyle.Solid,
                MinorGridlineStyle = LineStyle.Dot,
                MajorGridlineColor = OxyColors.LightGray,
                Minimum = -1.5,
                Maximum = 1.5,
                AxislineStyle = LineStyle.Solid,
                AxislineThickness = 2
            };

            var yAxis = new LinearAxis
            {
                Position = AxisPosition.Left,
                Title = "Imaginary",
                MajorGridlineStyle = LineStyle.Solid,
                MinorGridlineStyle = LineStyle.Dot,
                MajorGridlineColor = OxyColors.LightGray,
                Minimum = -1.5,
                Maximum = 1.5,
                AxislineStyle = LineStyle.Solid,
                AxislineThickness = 2
            };

            model.Axes.Add(xAxis);
            model.Axes.Add(yAxis);

            var unitCircle = new FunctionSeries(
                t => Math.Cos(t),
                t => Math.Sin(t),
                0, 2 * Math.PI, 1000)
            {
                Color = OxyColors.Red,
                StrokeThickness = 2,
                LineStyle = LineStyle.Dash,
                Title = "Unit Circle (|z|=1)"
            };
            model.Series.Add(unitCircle);

            model.Annotations.Add(new LineAnnotation
            {
                Type = LineAnnotationType.Vertical,
                X = 0,
                Color = OxyColors.Black,
                StrokeThickness = 1,
                LineStyle = LineStyle.Solid
            });

            model.Annotations.Add(new LineAnnotation
            {
                Type = LineAnnotationType.Horizontal,
                Y = 0,
                Color = OxyColors.Black,
                StrokeThickness = 1,
                LineStyle = LineStyle.Solid
            });

            var poleSeries = new ScatterSeries
            {
                MarkerType = MarkerType.Cross,
                MarkerSize = 12,
                MarkerStroke = OxyColors.Red,
                MarkerStrokeThickness = 3,
                Title = "Poles (X)"
            };

            foreach (var pole in poles)
            {
                poleSeries.Points.Add(new ScatterPoint(pole, 0));
            }
            model.Series.Add(poleSeries);

            if (zeros.Length > 0)
            {
                var zeroSeries = new ScatterSeries
                {
                    MarkerType = MarkerType.Circle,
                    MarkerSize = 12,
                    MarkerStroke = OxyColors.Blue,
                    MarkerStrokeThickness = 3,
                    MarkerFill = OxyColors.Transparent,
                    Title = "Zeros (O)"
                };

                foreach (var zero in zeros)
                {
                    zeroSeries.Points.Add(new ScatterPoint(zero, 0));
                }
                model.Series.Add(zeroSeries);
            }

            plotView.Model = model;
            plotView.Model.InvalidatePlot(true);
        }
    }

    public class SensorData
    {
        public double[][] Time { get; set; }
        public double[][] SensorValues { get; set; }

        public SensorData()
        {
            Time = new double[5][];
            SensorValues = new double[5][];
        }
    }
}
